# ═══════════════════════════════════════════════════════════════════════════════
# ClimaX Client - GitLab CI/CD Pipeline
# ═══════════════════════════════════════════════════════════════════════════════
# 
# This pipeline builds, tests, and deploys the Vue.js client application.
# 
# Required CI/CD Variables (Settings → CI/CD → Variables):
#   - CI_REGISTRY_USER: Docker registry username (auto-provided for GitLab Registry)
#   - CI_REGISTRY_PASSWORD: Docker registry password (auto-provided for GitLab Registry)
#   - VITE_BRIDGE_URL: Bridge API URL (e.g., http://climax-bridge.local)
#   - VITE_API_URL: Database API URL (e.g., https://api.climax.example.com)
#   - DEPLOY_HOST: SSH host for deployment
#   - DEPLOY_USER: SSH user for deployment
#   - DEPLOY_SSH_KEY: SSH private key for deployment (File type)
#
# ═══════════════════════════════════════════════════════════════════════════════

stages:
  - test
  - build
  - release
  - deploy

variables:
  # Docker image name
  IMAGE_NAME: $CI_REGISTRY_IMAGE
  # Node version for build
  NODE_VERSION: "20"
  # Docker driver for buildx
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

# ─────────────────────────────────────────────────────────────────────────────────
# Templates
# ─────────────────────────────────────────────────────────────────────────────────

.node_template: &node_template
  image: node:${NODE_VERSION}-alpine
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
      - .npm/
  before_script:
    - npm ci --cache .npm --prefer-offline

.docker_template: &docker_template
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY

# ─────────────────────────────────────────────────────────────────────────────────
# Test Stage
# ─────────────────────────────────────────────────────────────────────────────────

lint:
  <<: *node_template
  stage: test
  script:
    - npm run lint
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

typecheck:
  <<: *node_template
  stage: test
  script:
    - npm run build -- --mode development
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ─────────────────────────────────────────────────────────────────────────────────
# Build Stage
# ─────────────────────────────────────────────────────────────────────────────────

build:
  <<: *docker_template
  stage: build
  script:
    # Build with build args for environment
    - |
      docker build \
        --build-arg VITE_BRIDGE_URL="${VITE_BRIDGE_URL:-}" \
        --build-arg VITE_API_URL="${VITE_API_URL:-}" \
        --tag $IMAGE_NAME:$CI_COMMIT_SHA \
        --tag $IMAGE_NAME:$CI_COMMIT_REF_SLUG \
        .
    - docker push $IMAGE_NAME:$CI_COMMIT_SHA
    - docker push $IMAGE_NAME:$CI_COMMIT_REF_SLUG
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# ─────────────────────────────────────────────────────────────────────────────────
# Release Stage
# ─────────────────────────────────────────────────────────────────────────────────

release:
  <<: *docker_template
  stage: release
  script:
    - docker pull $IMAGE_NAME:$CI_COMMIT_SHA
    - docker tag $IMAGE_NAME:$CI_COMMIT_SHA $IMAGE_NAME:latest
    - docker push $IMAGE_NAME:latest
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  needs:
    - build

release-tag:
  <<: *docker_template
  stage: release
  script:
    - docker pull $IMAGE_NAME:$CI_COMMIT_SHA
    - docker tag $IMAGE_NAME:$CI_COMMIT_SHA $IMAGE_NAME:$CI_COMMIT_TAG
    - docker push $IMAGE_NAME:$CI_COMMIT_TAG
  rules:
    - if: $CI_COMMIT_TAG
  needs:
    - build

# ─────────────────────────────────────────────────────────────────────────────────
# Deploy Stage
# ─────────────────────────────────────────────────────────────────────────────────

deploy-staging:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$DEPLOY_SSH_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts 2>/dev/null
  script:
    - |
      ssh $DEPLOY_USER@$DEPLOY_HOST << EOF
        cd /opt/climax
        docker compose pull client
        docker compose up -d client
        docker image prune -f
      EOF
  environment:
    name: staging
    url: https://staging.climax.example.com
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
  needs:
    - release

deploy-production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$DEPLOY_SSH_KEY_PROD" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $DEPLOY_HOST_PROD >> ~/.ssh/known_hosts 2>/dev/null
  script:
    - |
      ssh $DEPLOY_USER_PROD@$DEPLOY_HOST_PROD << EOF
        cd /opt/climax
        docker compose pull client
        docker compose up -d client
        docker image prune -f
      EOF
  environment:
    name: production
    url: https://climax.example.com
  rules:
    - if: $CI_COMMIT_TAG
      when: manual
  needs:
    - release-tag
